{% extends "base.html" %}
{% load static %}

{% block title %}PDF to Braille{% endblock %}

{% block content %}
<div class="form-panel">
    <h1 class="form-title">üìÑ PDF TO BRAILLE</h1>
    
    <div class="form-group">
        <input 
            type="file" 
            id="pdfFile" 
            class="form-file" 
            accept=".pdf"
            aria-label="Select PDF file to convert"
        />
    </div>
    
    <button class="form-button" onclick="uploadPDF()">CONVERT & SEND</button>
    
    <div id="result" style="margin-top: 3rem; font-size: 2rem; text-align: center;"></div>
</div>

<!-- Back Button -->
<a href="{% url 'helper_menu' %}" class="back-button" role="button" aria-label="Go back">‚Üê BACK</a>

<div class="sr-only" role="status" aria-live="polite">
    {{ instruction }}
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function uploadPDF() {
    const fileInput = document.getElementById('pdfFile');
    const file = fileInput.files[0];
    
    if (!file) {
        speak('Error. Please select a PDF file');
        alert('Please select a PDF file first');
        return;
    }
    
    // Validate file type
    if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) {
        const errorMsg = 'Error. Invalid file format. Please select a valid PDF file.';
        document.getElementById('result').innerHTML = 
            '<div style="padding: 2rem; border: 2px solid #ff4444; border-radius: 8px; margin-top: 2rem;">' +
            '<h3 style="font-size: 1.8rem; color: #ff4444;">‚ùå INVALID FILE FORMAT</h3>' +
            '<p style="font-size: 1.2rem;">Only PDF files are supported.</p>' +
            '<p style="font-size: 1rem; margin-top: 1rem; opacity: 0.8;">Your file: ' + file.name + '</p>' +
            '</div>';
        speak(errorMsg);
        return;
    }
    
    // Validate file size (max 10MB)
    const maxSize = 10 * 1024 * 1024; // 10MB in bytes
    if (file.size > maxSize) {
        const errorMsg = 'Error. File is too large. Maximum size is 10 megabytes.';
        document.getElementById('result').innerHTML = 
            '<div style="padding: 2rem; border: 2px solid #ff4444; border-radius: 8px; margin-top: 2rem;">' +
            '<h3 style="font-size: 1.8rem; color: #ff4444;">‚ùå FILE TOO LARGE</h3>' +
            '<p style="font-size: 1.2rem;">Maximum file size is 10MB.</p>' +
            '<p style="font-size: 1rem; margin-top: 1rem; opacity: 0.8;">Your file size: ' + (file.size / (1024 * 1024)).toFixed(2) + ' MB</p>' +
            '</div>';
        speak(errorMsg);
        return;
    }
    
    const formData = new FormData();
    formData.append('pdf_file', file);
    
    document.getElementById('result').innerHTML = '<div class="loading-spinner"></div><p style="font-size: 1.3rem; margin-top: 1rem;">Extracting text from PDF...</p>';
    speak('Processing PDF file');
    
    fetch('{% url "helper_pdf_to_braille" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Server error: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        if (data.status === 'success') {
            document.getElementById('result').innerHTML = 
                '<div style="padding: 2rem; border: 2px solid var(--panel-border); border-radius: 8px; margin-top: 2rem;">' +
                '<h3 style="font-size: 1.8rem; color: #44ff44;">‚úÖ SUCCESS</h3>' +
                '<p style="font-size: 1.2rem;">' + data.message + '</p>' +
                '<hr style="border: 1px solid var(--panel-border); margin: 1rem 0;">' +
                '<p style="font-size: 1rem; opacity: 0.8;">üì§ ' + data.firebase_result.message + '</p>' +
                '</div>';
            speak('PDF converted and sent successfully');
        } else {
            document.getElementById('result').innerHTML = 
                '<div style="padding: 2rem; border: 2px solid #ff4444; border-radius: 8px; margin-top: 2rem;">' +
                '<h3 style="font-size: 1.8rem; color: #ff4444;">‚ùå ERROR</h3>' +
                '<p style="font-size: 1.2rem;">' + (data.message || 'Unknown error occurred') + '</p>' +
                '</div>';
            speak('Error processing PDF. ' + (data.message || 'Unknown error occurred'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('result').innerHTML = 
            '<div style="padding: 2rem; border: 2px solid #ff4444; border-radius: 8px; margin-top: 2rem;">' +
            '<h3 style="font-size: 1.8rem; color: #ff4444;">‚ùå CONNECTION ERROR</h3>' +
            '<p style="font-size: 1.2rem;">Please check your internet connection and try again.</p>' +
            '<p style="font-size: 1rem; margin-top: 1rem; opacity: 0.8;">Error details: ' + error.message + '</p>' +
            '</div>';
        speak('Error. Connection error. Please check your internet connection.');
    });
}

function speak(text) {
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.speak(utterance);
    }
}
</script>
{% endblock %}
